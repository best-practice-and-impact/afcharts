## Other customisations

`theme_af()` has arguments to control the legend position and appearance of grid lines, axis lines and axis ticks. More information on accepted values can be found in the [help file](https://best-practice-and-impact.github.io/afcharts/reference/theme_af.html).

### Sorting a bar chart

To control the order of bars in a chart, wrap the variable you want to arrange with `reorder()` and specify what variable you want to sort by. The following example sorts bars in ascending order of population from the bottom of the chart up. To sort in descending order, you would change this to `reorder(country, desc(pop))`.

```{r sorted, eval = FALSE}
population_chart <- pop_bar_data |>
  ggplot(aes(x = pop, y = reorder(country, pop))) +
  geom_col(fill = af_colour_values["dark-blue"]) +
  theme_af(axis = "y", grid = "x") +
  labs(x = NULL,
       y = NULL
    )
print(population_chart)
```

#### The U.S.A. is the most populous country in the Americas
##### Population of countries in the Americas (millions), 2007
```{r, echo = FALSE}
<<sorted>>
```

This bar chart uses the afcharts theme and shows the population of five countries. The country names are given on the y axis, with the bars extending from left to right, sorted by values decreasing from the top down. All the bars are in dark blue, and there is a small white gap between the bars and the y axis. The x axis values
are given in exponential notation.

Examples in the following sections iterate on this chart.

### Reducing space between chart and axis

By default, a bar chart will have a gap between the bottom of the bars and the axis. This can be removed as follows:

```{r expand, eval = FALSE}
last_plot() +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1)))
```

#### The U.S.A. is the most populous country in the Americas
##### Population of countries in the Americas (millions), 2007
```{r, echo = FALSE}
<<expand>>
```

This horizontal bar chart uses the afcharts theme. It shows the populations of five countries, with country names given on the y axis. All the bars are in dark blue and against the y axis. The x axis values are given in exponential notation.

The equivalent adjustment can be made for the y axis using `scale_y_continuous()`.

### Changing axis limits, breaks and labels

Axis limits, breaks and labels for continuous variables can be controlled using `scale_x/y_continuous()`. For discrete variables, labels can be changed using `scale_x/y_discrete()` or alternatively by recoding the variable in the data before creating a chart.

Limits, breaks and labels can be defined with custom values.

```{r axis-limits-breaks-labels-custom, eval = FALSE}
last_plot() +
  scale_x_continuous(
    breaks = seq(0, 400E6, 100E6),
    labels = seq(0, 400, 100),
    limits = c(0, 420E6),
    expand = expansion(mult = c(0, 0.1))
  ) +
  labs(
    x = "Population (millions)"
  )
```

#### The U.S.A. is the most populous country in the Americas
##### Population of countries in the Americas (millions), 2007
```{r, echo = FALSE}
<<axis-limits-breaks-labels-custom>>
```

This horizonal bar chart uses the afcharts theme and shows the populations of five countries. The country names are given on the y axis, and all the bars are in blue. The x axis is labeled every 100 from zero to 420. The x axis label indicates that population is reported in millions.

Adaptive axis limits and break for `scale_x/y_continuous()` can be defined using the `pretty()` function. This defines breaks that are equally spaced ‘round’ values which cover the range of the data and limits that are the next 'round' value just exceeding the range of the data. Setting the limits with a custom `limits_pretty()` function ensures the highest gridline value is above the maximum value of the data.

```{r axis-limits-breaks-labels-fct, eval = FALSE}
limits_pretty <- function(x) range(pretty(x))

last_plot() +
  scale_x_continuous(
    breaks = pretty,
    labels = label_number(scale = 1E-6),
    limits = limits_pretty,
    expand = expansion(mult = c(0, 0.2))
  ) +
  labs(
    x = "Population (millions)"
  )

```

#### The U.S.A. is the most populous country in the Americas
##### Population of countries in the Americas (millions), 2007
```{r, echo = FALSE}
<<axis-limits-breaks-labels-fct>>
```

This horizonal bar chart uses the afcharts theme and shows the populations of five countries. The country names are given on the y axis, and all the bars are in blue. The x axis is labeled every 100 from zero to 400. The x axis label indicates that population is reported in millions.

### Formatting labels

Formatting axis labels or legend labels is easily handled using the `scales` package. The following example formats y axis labels as percentages, however `scales` can also handle currency and thousands separators.

```{r using-scales, eval = FALSE}
stacked_bar_data |>
  ggplot(aes(x = continent, y = n_countries, fill = lifeExpGrouped)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_af(legend = "bottom") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.1)),
    labels = scales::percent
  ) +
  scale_fill_discrete_af() +
  labs(
    x = NULL,
    y = NULL,
    fill = "Life Expectancy"
  )
```

#### How life expectancy varies across continents
##### Percentage of countries by life expectancy band, 2007
```{r, fig.height = 5.5, echo = FALSE}
<<using-scales>>
```

This stacked bar uses the afcharts theme. The y axis is labelled from 0% to 100% every 25%, with light grey grid lines and tick marks going horizontally from the y axis. The top grid line is thinner than the others.

### Avoiding axis/grid lines being cut off

Axis lines and grid lines can sometimes appear 'cut off' if they are drawn at the limits of the chart range. In the previous plot, the top grid line is slightly narrower than the adjacent tick mark on the y axis. This is because the y axis limit is 100%. As the grid line is centred at 100%, the top half of the line is 'cut off'. This can be corrected as follows:

```{r clip, eval = FALSE}
last_plot() + coord_cartesian(clip = "off")
```

#### How life expectancy varies across continents
##### Percentage of countries by life expectancy band, 2007
```{r, fig.height = 5.5, echo = FALSE}
<<clip>>
```

This is a stacked bar chart with the afcharts theme, where the top gridline is the same width as the adjoining tick mark and other grid lines.

### Adding a line

To add a horizontal or vertical line across the whole plot, use `geom_hline()` or `geom_vline()`. This can be useful to highlight a threshold or average level.

```{r add-a-line, eval = FALSE}
gapminder |>
  filter(country == "United Kingdom") |>
  ggplot(aes(x = year, y = lifeExp)) +
  geom_line(linewidth = 1, colour = af_colour_values[1]) +
  geom_hline(
    yintercept = 75,
    colour = af_colour_values[2],
    linewidth = 1,
    linetype = "dashed"
  ) +
  annotate(geom = "text", x = 2007, y = 70, label = "Age 70") +
  theme_af() +
  scale_y_continuous(
    limits = c(0, 82),
    breaks = seq(0, 80, 20),
    expand = expansion(mult = c(0, 0.1))
  ) +
  scale_x_continuous(breaks = seq(1952, 2007, 5)) +
  labs(
    x = "Year",
    y = NULL
  )
```
#### Living Longer
##### Life Expectancy in the United Kingdom 1952-2007
```{r, echo=FALSE}
<<add-a-line>>
```

This line graph uses the afcharts theme. There is a solid dark blue line trending upwards, and a dashed teal line horizontal to 75 on the y-axis. There are also pale grey grid lines extending from regular intervals on the y axis.

### Embedding chart titles

As mentioned previously, chart titles, subtitles, and captions should be included as titles or the main body of the text where possible for accessibility purposes. However, these can embedded into the chart image with `labs()` if required. A title can be removed using `NULL`.

```{r chart-titles}
population_chart +
  labs(
    x = NULL,
    y = NULL,
    title = stringr::str_wrap(
      paste("The U.S.A. has the highest population in the Americas"),
      width = 40
    ),
    subtitle = "Population of countries of the Americas (millions), 2007",
    caption = "Source: Gapminder"
  )
```

In the chart image, the title gives a data insight and is presented in large bold text at the top. This is followed by smaller text giving a brief description of the data. In the bottom left of the image is a data citation as a caption.

### Wrapping text

If text is too long, it may be cut off or distort the dimensions of the chart.

```{r text-wrap-1}
plot <-
  ggplot(pop_bar_data, aes(x = reorder(country, -pop), y = pop)) +
  geom_col(fill = af_colour_values["dark-blue"]) +
  theme_af() +
  scale_y_continuous(labels = label_number(scale = 1E-6),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(
    x = NULL,
    subtitle = "Population of countries in the Americas (millions), 2007",
    caption = "Source: Gapminder"
  )

plot +
  labs(
    y = "Population of country",
    title = paste("The U.S.A. is the most populous country in ",
                  "the Americas")
  )
```

In this chart image, the title text is being cut off with only part of the text appearing in the image.

There are two suggested ways to solve this issue; Insert `\n` within a string to force a line break; Use `stringr::str_wrap()` to set a maximum character width of the string. See examples of both of these methods as follows:

```{r text-wrap-2}
plot +
  labs(
    y = "Population\n of country",
    title = stringr::str_wrap(
      paste("The U.S.A. is the most populous country in ",
            "the Americas"),
      width = 40
    )
  )
```

In this chart image, the y axis label and graph title text have been wrapped onto two lines so that all the text is visible.

### Adjusting theme elements

If you find you need to adjust theme elements for your chart, this can be done using `theme()`. Note that this should be done after the call to `theme_af()`, otherwise `theme_af()` may overwrite the specifications you've made.

```{r adjust-theme, eval = FALSE}
ggplot(pop_bar_data, aes(x = reorder(country, -pop), y = pop)) +
  geom_col(fill = af_colour_values["dark-blue"]) +
  theme_af(axis = "xy") +
  theme(
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(colour = "black")
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.1)),
    limits = c(0, 350E6),
    labels = scales::label_number(scale = 1E-6)
  ) +
  labs(
    x = NULL,
    y = NULL
  )
```

#### The U.S.A. is the most populous country in the Americas
##### Population of countries in the Americas (millions), 2007
```{r, echo = FALSE}
<<adjust-theme>>
```

This bar chart uses the afcharts theme. The bars are dark blue, with axis lines and ticks coloured black as opposed to the default `theme_af` grey.

You may also consider using markdown or HTML formatted text within your charts.
This can be readily achieved with `ggtext::element_markdown()`.

```{r html-formatting}
ann_data <- gapminder |>
  filter(country %in% c("United Kingdom", "China"))

ann_labs <- ann_data |>
  group_by(country) |>
  mutate(min_year = min(year)) |>
  filter(year == max(year)) |>
  ungroup()

ann_data |>
  ggplot(aes(x = year, y = lifeExp, colour = country)) +
  geom_line(linewidth = 1) +
  theme_af(legend = "none") +
  scale_colour_discrete_af() +
  scale_y_continuous(
    limits = c(0, 82),
    breaks = seq(0, 80, 20),
    expand = expansion(mult = c(0, 0.1))
  ) +
  scale_x_continuous(
    limits = c(1952, 2017),
    breaks = seq(1952, 2017, 5)
  ) +
  geom_label(
    data = ann_labs,
    aes(x = year, y = lifeExp, label = country),
    hjust = 0,
    vjust = 0.5,
    nudge_x = 0.5,
    label.size = NA
  ) +
  labs(
    x = "Year",
    y = NULL,
    title = "Living Longer",
    subtitle = "Life Expectancy in the
    <span style='color:darkorange;'>United Kingdom</span> and
    <span style='color:navy;'>China</span> 1952-2007",
    caption = "Source: Gapminder"
  ) +
  theme(plot.subtitle = element_markdown())
```

In this chart image, the subtitle and label text have been set to correspond to the line colours as a demonstration. Please refer to Analysis Function guidance in considering the accessibility of custom formatting.

